function openPaymentWindow(companyId, productId, productTitle, unitPrice) {
    var quantityInput = document.getElementById('crm-qty-' + productId) || document.getElementById('qty-' + productId);
    var quantity = parseInt(quantityInput ? quantityInput.value : 1) || 1;
    var paymentWindow = window.open('', '_blank', 'width=600,height=700,scrollbars=yes,resizable=yes');
    var totalPrice = (unitPrice * quantity).toFixed(2);
    
    var paymentHtml = '<html><head><title>Payment - Mizzanine</title><style>body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}.payment-container{background:white;border-radius:15px;max-width:500px;margin:0 auto;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.payment-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:2rem;text-align:center}.payment-header h2{margin:0 0 0.5rem 0;font-size:1.5rem}.payment-header p{margin:0;opacity:0.9}.payment-body{padding:2rem}.section-title{font-size:1.2rem;font-weight:600;color:#333;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}.order-summary{background:#f8f9ff;border-radius:12px;padding:1.5rem;margin-bottom:2rem;border-left:4px solid #667eea}.product-item{display:flex;flex-direction:column;gap:0.5rem}.product-name{font-weight:600;color:#333;font-size:1.1rem}.product-calc{color:#666;font-size:0.95rem}.product-total{font-weight:600;color:#333;font-size:1rem}.product-total .price{color:#667eea;font-size:1.1rem}.delivery-section{margin-bottom:2rem}.delivery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem}.delivery-card{background:white;border:2px solid #e9ecef;border-radius:12px;padding:1rem;text-align:center;cursor:pointer;transition:all 0.3s ease;position:relative}.delivery-card:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,0.15)}.delivery-card.selected{border-color:#667eea;background:#f8f9ff;box-shadow:0 8px 25px rgba(102,126,234,0.15)}.delivery-card.selected::after{content:"‚úì";position:absolute;top:-8px;right:-8px;background:#28a745;color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:bold}.delivery-header{font-weight:600;color:#333;margin-bottom:0.5rem;font-size:0.9rem}.delivery-company{color:#667eea;font-weight:500;margin-bottom:0.25rem;font-size:0.85rem}.delivery-time{color:#666;font-size:0.8rem;margin-bottom:0.5rem}.delivery-price{font-weight:600;color:#28a745;font-size:1rem}.payment-section{margin-bottom:2rem}.payment-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.payment-card{background:white;border:2px solid #e9ecef;border-radius:12px;padding:1.5rem;text-align:center;cursor:pointer;transition:all 0.3s ease;position:relative}.payment-card:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,0.15)}.payment-card.selected{border-color:#667eea;background:#f8f9ff;box-shadow:0 8px 25px rgba(102,126,234,0.15)}.payment-card.selected::after{content:"‚úì";position:absolute;top:-8px;right:-8px;background:#28a745;color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:bold}.payment-icon{font-size:2rem;margin-bottom:0.5rem}.payment-name{font-weight:600;color:#333;margin-bottom:0.25rem}.payment-desc{color:#666;font-size:0.85rem}.total-section{background:#f8f9fa;border-radius:12px;padding:1.5rem;margin-bottom:1rem}.total-breakdown{display:flex;flex-direction:column;gap:0.75rem}.total-line{display:flex;justify-content:space-between;align-items:center;font-size:1rem}.total-line.final{border-top:2px solid #667eea;padding-top:0.75rem;font-weight:600;font-size:1.2rem;color:#333}.payment-footer{padding:1.5rem 2rem;background:#f8f9fa;border-top:1px solid #e9ecef}.complete-btn{width:100%;background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;border:none;border-radius:12px;padding:1rem 2rem;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:0.5rem}.complete-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(40,167,69,0.3)}.btn-icon{font-size:1.2rem}.close-btn{background:#dc3545;color:white;border:none;padding:0.5rem 1rem;border-radius:5px;cursor:pointer;margin-left:1rem}</style></head><body><div class="payment-container"><div class="payment-header"><h2>üîí Secure Payment with Torbiona</h2><p>Complete your purchase securely</p></div><div class="payment-body"><div class="section-title">üì¶ Order Summary</div><div class="order-summary"><div class="product-item"><div class="product-name">' + productTitle + '</div><div class="product-calc">Qty: ' + quantity + ' √ó $' + unitPrice + '</div><div class="product-total">Product Total: <span class="price">$' + totalPrice + '</span></div></div></div><div class="section-title">üöö Delivery Options</div><div class="delivery-section"><div class="delivery-grid"><div class="delivery-card" onclick="selectDelivery(this, \'fast_50\', ' + totalPrice + ')"><div class="delivery-header">‚ö° Fast Delivery</div><div class="delivery-company">ŸÅÿßÿ≥ÿ™ ŸÑŸàÿ¨Ÿäÿ≥ÿ™ŸÉ</div><div class="delivery-time">Same Day</div><div class="delivery-price">50 SAR</div></div><div class="delivery-card" onclick="selectDelivery(this, \'standard_25\', ' + totalPrice + ')"><div class="delivery-header">üì¶ Standard</div><div class="delivery-company">ŸÅÿßÿ≥ÿ™ ŸÑŸàÿ¨Ÿäÿ≥ÿ™ŸÉ</div><div class="delivery-time">2-3 Days</div><div class="delivery-price">25 SAR</div></div><div class="delivery-card selected" onclick="selectDelivery(this, \'none_0\', ' + totalPrice + ')"><div class="delivery-header">üè™ Pickup</div><div class="delivery-company">Self Pickup</div><div class="delivery-time">No Delivery</div><div class="delivery-price">Free</div></div></div></div><div class="section-title">üí≥ Payment Method</div><div class="payment-section"><div class="payment-grid"><div class="payment-card selected" onclick="selectPayment(this, \'torbiona\')"><div class="payment-icon">üîí</div><div class="payment-name">Torbiona</div><div class="payment-desc">Secure financing</div></div><div class="payment-card" onclick="selectPayment(this, \'pay-now\')"><div class="payment-icon">üí≥</div><div class="payment-name">Pay Now</div><div class="payment-desc">Instant payment</div></div></div></div><div class="total-section"><div class="total-breakdown"><div class="total-line"><span>Product Total:</span><span>$' + totalPrice + '</span></div><div class="total-line"><span>Delivery Fee:</span><span id="deliveryFee">Free</span></div><div class="total-line final"><span>Final Total:</span><span id="finalTotal">$' + totalPrice + '</span></div></div></div></div><div class="payment-footer"><button class="complete-btn" onclick="completePayment(\'' + companyId + '\',\'' + productId + '\',\'' + productTitle + '\',\'' + quantity + '\',\'' + totalPrice + '\')" id="completeBtn"><span class="btn-icon">üîê</span><span class="btn-text">Complete Purchase</span></button><button class="close-btn" onclick="window.close()">Close</button></div></div><script>var selectedDelivery="none_0";var selectedPayment="torbiona";function selectDelivery(card,value,basePrice){document.querySelectorAll(".delivery-card").forEach(c=>c.classList.remove("selected"));card.classList.add("selected");selectedDelivery=value;var deliveryFee=parseInt(value.split("_")[1]);var finalTotal=(parseFloat(basePrice)+deliveryFee).toFixed(2);document.getElementById("finalTotal").textContent="$"+finalTotal;document.getElementById("deliveryFee").textContent=deliveryFee===0?"Free":deliveryFee+" SAR"}function selectPayment(card,value){document.querySelectorAll(".payment-card").forEach(c=>c.classList.remove("selected"));card.classList.add("selected");selectedPayment=value}function completePayment(companyId,productId,productTitle,quantity,totalPrice){var deliveryFee=parseInt(selectedDelivery.split("_")[1]);var finalTotal=(parseFloat(totalPrice)+deliveryFee).toFixed(2);if(selectedPayment==="torbiona"){var orderData={companyId:companyId,productId:productId,productTitle:productTitle,quantity:quantity,unitPrice:(parseFloat(totalPrice)/quantity).toFixed(2),totalPrice:finalTotal,deliveryFee:deliveryFee};var encodedOrder=encodeURIComponent(JSON.stringify(orderData));window.location.href="/torbiona-calculator?order="+encodedOrder}else{alert("Payment successful! Total: $"+finalTotal);window.close()}}</script></body></html>';
    
    paymentWindow.document.write(paymentHtml);
}