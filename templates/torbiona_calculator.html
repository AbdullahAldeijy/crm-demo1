<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ 'rtl' if lang == 'ar' else 'ltr' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torbiona Calculator - {{ t.site_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .calculator-container { max-width: 600px; margin: 2rem auto; padding: 2rem; }
        .calculator-header { text-align: center; margin-bottom: 2rem; }
        .score-display { font-size: 3rem; font-weight: bold; margin: 1rem 0; }
        .score-approved { color: #28a745; }
        .score-declined { color: #dc3545; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 1rem 0; }
        .progress-fill { height: 100%; transition: width 2s ease; }
        .approved { background: linear-gradient(90deg, #28a745, #20c997); }
        .declined { background: linear-gradient(90deg, #dc3545, #fd7e14); }
        .result-message { padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0; text-align: center; }
        .result-approved { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result-declined { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .action-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; }
        .partners-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; justify-items: center; }
        .partner-logo { width: 120px; height: 60px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .partner-logo:hover { transform: scale(1.05); }
        @media (max-width: 768px) { .partners-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">{{ t.site_name }}</h1>
        </div>
    </nav>

    <div class="calculator-container">
        <div class="calculator-header">
            <h1>ğŸ” Torbiona Credit Calculator</h1>
            <p>{{ 'ØªÙ‚ÙŠÙŠÙ… Ø£Ù‡Ù„ÙŠØªÙƒ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± ØªÙˆØ±Ø¨ÙŠÙˆÙ†Ø§' if lang == 'ar' else 'Evaluating your Torbiona payment eligibility' }}</p>
        </div>

        <div class="card" style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <h3>{{ 'ØªØ­Ù„ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±ÙƒØ©' if lang == 'ar' else 'Company History Analysis' }}</h3>
            
            <div class="analysis-item">
                <span>{{ 'Ø§Ù„Ø³Ù„ÙˆÙƒÙŠ' if lang == 'ar' else 'Behavioral' }}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ behavioral }}%; background: #17a2b8;"></div>
                </div>
                <span>{{ behavioral }}%</span>
            </div>

            <div class="analysis-item" style="margin: 1rem 0;">
                <span>{{ 'Ø§Ù„Ù…Ø§Ù„ÙŠ' if lang == 'ar' else 'Financial' }}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ financial }}%; background: #6f42c1;"></div>
                </div>
                <span>{{ financial }}%</span>
            </div>

            <div class="analysis-item" style="margin: 1rem 0;">
                <span>{{ 'Ø§Ù„Ø³ÙˆÙ‚' if lang == 'ar' else 'Market' }}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ market }}%; background: #28a745;"></div>
                </div>
                <span>{{ market }}%</span>
            </div>

            <div class="analysis-item" style="margin: 1rem 0;">
                <span>{{ 'Ø§Ù„ØªÙ‚Ù†ÙŠ ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ÙŠ' if lang == 'ar' else 'Technical and Operational' }}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ technical }}%; background: #fd7e14;"></div>
                </div>
                <span>{{ technical }}%</span>
            </div>

            <div class="analysis-item">
                <span>{{ 'Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠ ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ' if lang == 'ar' else 'Governmental and Regulatory' }}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ governmental }}%; background: #dc3545;"></div>
                </div>
                <span>{{ governmental }}%</span>
            </div>

            <div class="score-display {{ 'score-approved' if approved else 'score-declined' }}">
                {{ score }}%
            </div>

            {% if approved %}
            <div class="result-message result-approved">
                <h3>âœ… {{ 'ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©!' if lang == 'ar' else 'Approved!' }}</h3>
                <p>{{ 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£Ù†Øª Ù…Ø¤Ù‡Ù„ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± ØªÙˆØ±Ø¨ÙŠÙˆÙ†Ø§' if lang == 'ar' else 'Congratulations! You are eligible for Torbiona payment method.' }}</p>
                <p><strong>{{ 'Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù† Ø§Ù„Ù…ØªØ§Ø­' if lang == 'ar' else 'Available Credit Limit' }}: $50,000</strong></p>
            </div>
            {% else %}
            <div class="result-message result-declined">
                <h3>âŒ {{ 'ØºÙŠØ± Ù…Ø¤Ù‡Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹' if lang == 'ar' else 'Not Eligible Currently' }}</h3>
                <p>{{ 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙˆØ±Ø¨ÙŠÙˆÙ†Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙÙˆØ±ÙŠ.' if lang == 'ar' else 'Sorry, you cannot use Torbiona payment method now. Please use Pay Now method.' }}</p>
                <p><strong>{{ 'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: 50%' if lang == 'ar' else 'Required Score: 50%' }}</strong></p>
            </div>
            {% endif %}

            <div class="action-buttons">
                {% if approved %}
                <button class="btn btn-primary" onclick="proceedWithTorbiona()">
                    {{ 'Ù…ØªØ§Ø¨Ø¹Ø© Ø¨ØªÙˆØ±Ø¨ÙŠÙˆÙ†Ø§' if lang == 'ar' else 'Proceed with Torbiona' }}
                </button>
                {% endif %}
                <button class="btn btn-secondary" onclick="usePayNow()">
                    {{ 'Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙÙˆØ±ÙŠ' if lang == 'ar' else 'Use Pay Now' }}
                </button>
                <button class="btn btn-info" onclick="goBack()">
                    {{ 'Ø§Ù„Ø¹ÙˆØ¯Ø©' if lang == 'ar' else 'Go Back' }}
                </button>
            </div>
        </div>
        
        <div class="partners-section" style="margin-top: 3rem;">
            <h3 style="text-align: center; margin-bottom: 2rem;">{{ 'Ø´Ø±ÙƒØ§Ø¤Ù†Ø§' if lang == 'ar' else 'Our Partners' }}</h3>
            <div class="partners-grid">
                <img src="{{ url_for('static', filename='images/nafath.png') }}" alt="Nafath" class="partner-logo">
                <img src="{{ url_for('static', filename='images/etimad.png') }}" alt="Etimad" class="partner-logo">
                <img src="{{ url_for('static', filename='images/simah.png') }}" alt="Simah" class="partner-logo">
                <img src="{{ url_for('static', filename='images/commerce.png') }}" alt="Commerce" class="partner-logo">
                <img src="{{ url_for('static', filename='images/gosi.jpg') }}" alt="GOSI" class="partner-logo">
                <img src="{{ url_for('static', filename='images/nafith.jpg') }}" alt="Nafith" class="partner-logo">
                <img src="{{ url_for('static', filename='images/najiz.jpg') }}" alt="Najiz" class="partner-logo">
                <img src="{{ url_for('static', filename='images/zakat.jpg') }}" alt="Zakat" class="partner-logo">
            </div>
        </div>
    </div>

    <script>
        // Parse order data from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const orderParam = urlParams.get('order');
        let orderData = null;
        
        if (orderParam) {
            try {
                orderData = JSON.parse(decodeURIComponent(orderParam));
                console.log('Parsed order data:', orderData);
            } catch (e) {
                console.error('Failed to parse order data:', e);
            }
        }
        
        const approved = {{ 'true' if approved else 'false' }};

        function proceedWithTorbiona() {
            console.log('Proceed with Torbiona clicked');
            console.log('Approved:', approved);
            console.log('Order data:', orderData);
            
            if (!approved) {
                alert('{{ "ØºÙŠØ± Ù…Ø¤Ù‡Ù„ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± ØªÙˆØ±Ø¨ÙŠÙˆÙ†Ø§" if lang == "ar" else "Not eligible for Torbiona payment" }}');
                return;
            }
            
            if (!orderData) {
                alert('{{ "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©" if lang == "ar" else "Order data not available" }}');
                console.error('Order data is null or undefined');
                return;
            }
            
            // Generate contracts first
            fetch('/api/generate_contracts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    seller_company: orderData.companyId,
                    product_title: orderData.productTitle,
                    quantity: orderData.quantity,
                    total_amount: orderData.totalPrice
                })
            })
            .then(response => {
                console.log('Contract response:', response);
                return response.json();
            })
            .then(contractData => {
                console.log('Contract data:', contractData);
                if (contractData.success) {
                    // Then process payment
                    return fetch('/api/purchase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            company_id: orderData.companyId,
                            product_id: orderData.productId,
                            quantity: orderData.quantity,
                            payment_method: 'torbiona',
                            total_amount: orderData.totalPrice
                        })
                    });
                } else {
                    throw new Error('Contract generation failed');
                }
            })
            .then(response => {
                console.log('Purchase response:', response);
                return response.json();
            })
            .then(data => {
                console.log('Purchase data:', data);
                if (data.success) {
                    alert('{{ "ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± ØªÙˆØ±Ø¨ÙŠÙˆÙ†Ø§! ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ÙŠÙ†: Ø§Ù„Ø£ÙˆÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙˆØªÙˆØ±Ø¨ÙŠÙˆÙ†Ø§ØŒ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹" if lang == "ar" else "Payment successful via Torbiona! Two contracts generated: 1) Buyer-Torbiona 2) Buyer-Seller" }}');
                    window.close();
                } else {
                    alert('{{ "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØ¹: " if lang == "ar" else "Payment failed: " }}' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{{ "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: " if lang == "ar" else "Transaction error: " }}' + error.message);
            });
        }

        function usePayNow() {
            console.log('Pay Now clicked');
            console.log('Order data:', orderData);
            
            if (!orderData) {
                alert('{{ "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©" if lang == "ar" else "Order data not available" }}');
                console.error('Order data is null or undefined');
                return;
            }
            
            // Process immediate payment
            fetch('/api/purchase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_id: orderData.companyId,
                    product_id: orderData.productId,
                    quantity: orderData.quantity,
                    payment_method: 'pay-now',
                    total_amount: orderData.totalPrice
                })
            })
            .then(response => {
                console.log('Pay now response:', response);
                return response.json();
            })
            .then(data => {
                console.log('Pay now data:', data);
                if (data.success) {
                    alert('{{ "ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" if lang == "ar" else "Payment successful! Contract automatically generated between buyer and seller." }}');
                    window.close();
                } else {
                    alert('{{ "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØ¹: " if lang == "ar" else "Payment failed: " }}' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{{ "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: " if lang == "ar" else "Transaction error: " }}' + error.message);
            });
        }

        function goBack() {
            window.history.back();
        }

        // Animate progress bars on load
        window.addEventListener('load', () => {
            const progressBars = document.querySelectorAll('.progress-fill');
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = width;
                }, 500);
            });
        });
    </script>
</body>
</html>